{% load static %} 

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WildLens - D√©tection d'empreintes de mammif√®res</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #31c48d;
            --secondary-color: #83ebc5;
            --accent-color: #31c48d;
            --dark-color: #1d9e6f;
            --light-color: #e8f5e9;
            --text-color: #212121;
            --light-text: #f5f5f5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: var(--light-color);
        }

        .navbar {
            background-color: var(--primary-color);
        }

        .navbar-brand,
        .nav-link {
            color: #060c06 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--dark-color);
            border-color: var(--dark-color);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1511497584788-876760111969?ixlib=rb-1.2.1&auto=format&fit=crop&w=1489&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            margin-bottom: 30px;
        }

        .feature-card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .upload-area {
            border: 2px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .upload-area:hover {
            background-color: rgba(129, 199, 132, 0.1);
        }

        .map-container {
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .result-card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .confidence-bar {
            height: 10px;
            border-radius: 5px;
            background-color: #e0e0e0;
            margin-bottom: 5px;
        }

        .confidence-level {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 5px;
        }

        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 30px 0;
            margin-top: 50px;
        }

        .species-info {
            display: none;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .hero-section {
                padding: 60px 0;
            }

            .feature-card {
                margin-bottom: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <a class="navbar-brand" href="#">
                    <img src="{% static 'wildaware-high-resolution-color-logo-crop.png' %}" alt="WildLens Logo" height="30" class="d-inline-block align-top me-2">
                </a>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#home">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#detect">D√©tecter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#gallery">Galerie</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about">√Ä propos</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section text-center" id="home">
        <div class="container">
            <h1 class="display-4 fw-bold mb-4">Identifiez les empreintes de mammif√®res</h1>
            <p class="lead mb-5">D√©couvrez la faune sauvage qui vous entoure gr√¢ce √† notre technologie de reconnaissance
                d'empreintes bas√©e sur l'intelligence artificielle</p>
            <a href="#detect" class="btn btn-light btn-lg px-4 me-2">Commencer</a>
            <a href="#about" class="btn btn-outline-light btn-lg px-4">En savoir plus</a>
        </div>
    </section>

    <!-- Features Section -->
    <section class="py-5">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">Comment √ßa fonctionne</h2>
                <p class="lead text-muted">Notre technologie combine l'analyse d'image et les donn√©es g√©ographiques</p>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <h5 class="card-title">Capturez l'empreinte</h5>
                            <p class="card-text">Prenez une photo claire de l'empreinte que vous avez trouv√©e dans la
                                nature</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <h5 class="card-title">Indiquez la r√©gion</h5>
                            <p class="card-text">Pr√©cisez o√π vous avez trouv√© l'empreinte pour am√©liorer la pr√©cision
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h5 class="card-title">Identifiez l'animal</h5>
                            <p class="card-text">Notre IA analyse l'image et vous indique √† quel animal appartient
                                l'empreinte</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Detection Section -->
    <section class="py-5 bg-white" id="detect">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">D√©tectez une empreinte</h2>
                <p class="lead text-muted">T√©l√©chargez une photo et d√©couvrez √† quel animal elle appartient</p>
            </div>
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">T√©l√©chargez votre image</h5>
                            <div class="upload-area" id="uploadArea">
                                <input type="file" id="imageUpload" accept="image/*" hidden>
                                <div id="uploadPlaceholder">
                                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                    <p class="mb-0">Cliquez ou glissez-d√©posez votre image ici</p>
                                    <p class="small text-muted">Formats accept√©s: JPG, PNG</p>
                                </div>
                                <div id="imagePreviewContainer" style="display: none;">
                                    <img id="imagePreview" class="img-fluid rounded mb-3" alt="Aper√ßu de l'image">
                                    <button class="btn btn-sm btn-outline-danger" id="removeImage">Supprimer</button>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary me-2" id="captureButton">
                                    <i class="fas fa-camera me-1"></i> Prendre une photo
                                </button>
                                <button class="btn btn-outline-secondary" id="galleryButton">
                                    <i class="fas fa-images me-1"></i> Choisir un exemple
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">S√©lectionnez la r√©gion</h5>
                            <select class="form-select mb-3" id="regionSelect">
                                <option selected disabled>Choisissez une r√©gion</option>
                                <option value="europe">Europe</option>
                                <option value="amerique_nord">Am√©rique du Nord</option>
                                <option value="amerique_sud">Am√©rique du Sud</option>
                                <option value="asie">Asie</option>
                                <option value="afrique">Afrique</option>
                                <option value="australie">Australie</option>
                            </select>
                            <!-- <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="useLocation">
                                <label class="form-check-label" for="useLocation">
                                    Utiliser ma position actuelle
                                </label>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <input type="hidden" name="csrfToken" value="{{ csrf_token }}">
                <button class="btn bg-success btn-lg px-4" style="color: white;" id="detectButton" disabled>
                    <i class="fas fa-search me-2"></i>Identifier l'empreinte
                </button>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Analyse en cours, veuillez patienter...</p>
            </div>

            <!-- Results Section (initially hidden) -->
            <div class="results-section mt-5" id="resultsSection" style="display: none;">
                <h3 class="text-center mb-4">R√©sultats de l'analyse</h3>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card result-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Esp√®ce identifi√©e</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <img id="speciesImage" src="https://via.placeholder.com/100" class="rounded me-3"
                                        width="100" alt="Esp√®ce identifi√©e">
                                    <div>
                                        <h4 id="speciesName">Nom de l'esp√®ce</h4>
                                        <p id="speciesLatinName" class="text-muted fst-italic mb-0">Nom latin</p>
                                    </div>
                                </div>
                                <h6>Niveau de confiance</h6>
                                <div class="confidence-bar">
                                    <div class="confidence-level" id="confidenceLevel" style="width: 85%;"></div>
                                </div>
                                <p id="confidenceText" class="text-end">85%</p>
                                <h6>Autres possibilit√©s</h6>
                                <ul class="list-group" id="alternativesList">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Esp√®ce alternative 1
                                        <span class="badge bg-primary rounded-pill">10%</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Esp√®ce alternative 2
                                        <span class="badge bg-primary rounded-pill">5%</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card result-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Informations sur l'esp√®ce</h5>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" id="speciesTabs" style="color: black;">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab"
                                            href="#description">Description</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#habitat">Habitat</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#empreintes">Empreintes</a>
                                    </li>
                                </ul>
                                <div class="tab-content p-3">
                                    <div class="tab-pane fade show active" id="description">
                                        <p id="speciesDescription">Description d√©taill√©e de l'esp√®ce...</p>
                                    </div>
                                    <div class="tab-pane fade" id="habitat">
                                        <p id="speciesHabitat">Informations sur l'habitat...</p>
                                        <div id="distributionMap" class="mt-3">
                                            <!-- Distribution map will be loaded here -->
                                            <img src="https://via.placeholder.com/400x200?text=Carte+de+distribution"
                                                class="img-fluid rounded" alt="Carte de distribution">
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="empreintes">
                                        <p id="trackInfo">Informations sur les empreintes...</p>
                                        <div class="row mt-3">
                                            <div class="col-6">
                                                <img src="https://via.placeholder.com/200?text=Empreinte+avant"
                                                    class="img-fluid rounded" alt="Empreinte avant">
                                                <p class="text-center mt-1">Patte avant</p>
                                            </div>
                                            <div class="col-6">
                                                <img src="https://via.placeholder.com/200?text=Empreinte+arri√®re"
                                                    class="img-fluid rounded" alt="Empreinte arri√®re">
                                                <p class="text-center mt-1">Patte arri√®re</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Gallery Section -->
    <section class="py-5" id="gallery">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">Galerie d'empreintes</h2>
                <p class="lead text-muted">Explorez notre collection d'empreintes identifi√©es</p>
            </div>
            <div class="row g-4">
                <!-- Gallery items will be dynamically loaded here -->
                <div class="col-md-4 col-sm-6">
                    <div class="card feature-card">
                        <img src="{% static 'animauxdemo/fox.jpeg' %}" class="card-img-top"
                            alt="Empreinte de Renard2">
                        <div class="card-body">
                            <h5 class="card-title">Renard</h5>
                            <p class="card-text">Empreinte typique de renard trouv√©e en for√™t</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card feature-card">
                        <img src="{% static 'animauxdemo/wolf.jpg' %}" class="card-img-top"
                            alt="Empreinte de Loup">
                        <div class="card-body">
                            <h5 class="card-title">Loup</h5>
                            <p class="card-text">Empreinte de loup identifi√©e en montagne</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card feature-card">
                        <img src="{% static 'animauxdemo/ours.jpg' %}" class="card-img-top"
                            alt="Empreinte d'Ours">
                        <div class="card-body">
                            <h5 class="card-title">Ours</h5>
                            <p class="card-text">Empreinte d'ours brun dans une zone foresti√®re</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card feature-card">
                        <img src="{% static 'animauxdemo/lynx.jpg' %}" class="card-img-top"
                            alt="Empreinte de Lynx">
                        <div class="card-body">
                            <h5 class="card-title">Lynx</h5>
                            <p class="card-text">Empreinte de lynx trouv√©e en zone montagneuse</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card feature-card">
                        <img src="{% static 'animauxdemo/beaver.jpg' %}" class="card-img-top"
                            alt="Empreinte de Castor">
                        <div class="card-body">
                            <h5 class="card-title">Castor</h5>
                            <p class="card-text">Empreinte de castor pr√®s d'un cours d'eau</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card feature-card">
                        <img src="{% static 'animauxdemo/raccoon.jpg' %}"
                            class="card-img-top" alt="Empreinte de Raton Laveur">
                        <div class="card-body">
                            <h5 class="card-title">Raton Laveur</h5>
                            <p class="card-text">Empreinte caract√©ristique de raton laveur</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div class="text-center mt-4">
                <button class="btn btn-outline-primary">Voir plus d'exemples</button>
            </div> -->
        </div>
    </section>

    <!-- About Section -->
    <section class="py-5 bg-white" id="about">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">√Ä propos du projet</h2>
                <p class="lead text-muted">D√©couvrez comment nous utilisons l'IA pour la conservation de la faune</p>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <img src="{% static 'creepeople.png' %}" alt="WildLens" class="w-100">
                </div>
                <div class="col-lg-6">
                    <h3>Notre mission</h3>
                    <p>WildLens est une association fran√ßaise engag√©e dans la protection animale dans les r√©gions
                        sauvages. Nous collectons des fonds pour financer nos actions et menons des campagnes de
                        sensibilisation en for√™t pour informer le public sur les enjeux de la conservation de la faune
                        sauvage.</p>
                    <p>Notre application d'identification d'empreintes vise √† sensibiliser le public √† la pr√©servation
                        de la faune sauvage de fa√ßon ludique, en leur montrant les traces laiss√©es par ces animaux dans
                        leur habitat naturel.</p>
                    <h3 class="mt-4">Notre technologie</h3>
                    <p>Notre syst√®me utilise un mod√®le hybride qui combine :</p>
                    <ul>
                        <li>Une analyse visuelle des empreintes via un r√©seau de neurones convolutifs (CNN)</li>
                        <li>Des informations sur la distribution g√©ographique des esp√®ces</li>
                        <li>Des techniques avanc√©es de traitement d'image pour extraire les caract√©ristiques
                            distinctives</li>
                    </ul>
                    <p>Cette approche nous permet d'atteindre une pr√©cision d'identification sup√©rieure √† 89%.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <a class="navbar-brand" href="#">
                        <img src="{% static 'wildaware-high-resolution-color-logo-crop.png' %}" alt="WildLens Logo" height="30" class="d-inline-block align-top me-2">
                    </a>
                    <p>Sensibiliser √† la pr√©servation de la faune sauvage gr√¢ce √† la technologie</p>
                    <div class="social-icons">
                        <a href="#" class="text-white me-3"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <h5>Liens rapides</h5>
                    <ul class="list-unstyled">
                        <li><a href="#home" class="text-white">Accueil</a></li>
                        <li><a href="#detect" class="text-white">D√©tecter</a></li>
                        <li><a href="#gallery" class="text-white">Galerie</a></li>
                        <li><a href="#about" class="text-white">√Ä propos</a></li>
                        <li><a href="#" class="text-white">Politique de confidentialit√©</a></li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <h5>Contact</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-map-marker-alt me-2"></i> 123 Rue de la Nature, 75000 Paris</li>
                        <li><i class="fas fa-phone me-2"></i> +33 1 23 45 67 89</li>
                        <li><i class="fas fa-envelope me-2"></i> contact@wildlens.org</li>
                    </ul>
                </div>
            </div>
            <hr class="my-4 bg-light">
            <div class="text-center">
                <p class="mb-0">&copy; 2025 WildLens. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <!-- Camera Modal -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Prendre une photo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <video id="cameraFeed" class="img-fluid rounded mb-3" autoplay></video>
                        <canvas id="captureCanvas" style="display: none;"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="takePictureButton">
                        <i class="fas fa-camera me-1"></i> Capturer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Species Info Templates (Hidden) -->
    <div class="species-info" id="species-castor">
        <div class="species-data" data-name="Castor" data-latin="Castor canadensis"
            data-image="https://via.placeholder.com/100?text=Castor"
            data-description="Le castor d'Europe, appel√© √©galement le castor commun ou le castor d'Eurasie, est un mammif√®re rongeur aquatique de la famille des castorid√©s. √Ä l'exception des humains, le castor est l'un des seuls mammif√®res qui fa√ßonnent son environnement."
            data-habitat="Le castor d'Europe vit le long des rivi√®res, des ruisseaux, des lacs et des √©tangs."
            data-track-info="Les empreintes de castor sont caract√©ris√©es par 5 orteils avec des griffes visibles et une palmure entre les doigts. La patte arri√®re est beaucoup plus grande que la patte avant.">
        </div>
    </div>

    <div class="species-info" id="species-renard">
        <div class="species-data" data-name="Renard" data-latin="Vulpes vulpes"
            data-image="https://via.placeholder.com/100?text=Renard"
            data-description="Le renard roux, appel√© √©galement le renard commun ou le renard rouge, est un mammif√®re carnivore de la famille des canid√©s. Les renards utilisent le champ magn√©tique de la Terre comme un 'radar' pour chasser."
            data-habitat="L'esp√®ce vit dans les for√™ts, les champs, les prairies, les toundras, les steppes, les montagnes."
            data-track-info="L'empreinte du renard ressemble √† celle d'un petit chien, avec 4 coussinets digitaux et un coussinet plantaire en forme de triangle. Les griffes sont visibles et l'empreinte est plus allong√©e et plus √©troite que celle du chien.">
        </div>
    </div>

    <!-- Scripts -->
    <script>
        function convertDMSToDecimal(dms, ref) {
            if (!Array.isArray(dms)) return null;
            const [deg, min, sec] = dms;
            let decimal = deg + min / 60 + sec / 3600;
            if (ref === 'S' || ref === 'W') decimal *= -1;
            return decimal;
        }

        function extractCoordinates(exifData) {
            let lat = null;
            let lon = null;

            // Latitude
            if (exifData.GPSLatitude && exifData.GPSLatitudeRef) {
                lat = convertDMSToDecimal(exifData.GPSLatitude, exifData.GPSLatitudeRef);
            } else if (exifData.Latitude && exifData.LatitudeRef) {
                lat = convertDMSToDecimal(exifData.Latitude, exifData.LatitudeRef);
            } else if (exifData.lat || exifData.latitude || exifData.Lat) {
                lat = exifData.lat || exifData.latitude || exifData.Lat;
            }

            // Longitude
            if (exifData.GPSLongitude && exifData.GPSLongitudeRef) {
                lon = convertDMSToDecimal(exifData.GPSLongitude, exifData.GPSLongitudeRef);
            } else if (exifData.Longitude && exifData.LongitudeRef) {
                lon = convertDMSToDecimal(exifData.Longitude, exifData.LongitudeRef);
            } else if (exifData.lon || exifData.longitude || exifData.Lng || exifData.Long) {
                lon = exifData.lon || exifData.longitude || exifData.Lng || exifData.Long;
            }

            // Alternative string format genre "Location": "43.467448, 11.885126"
            if ((!lat || !lon) && exifData.Location) {
                const match = exifData.Location.match(/(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lon = parseFloat(match[3]);
                }
            }

            if (lat !== null && lon !== null) {
                return { latitude: lat, longitude: lon };
            } else {
                return null;
            }
        }
        function extractExifDate(exifData) {
            const dateFields = [
                'DateTimeOriginal',
                'DateTimeDigitized',
                'DateTime',
                'CreateDate',
                'CreationDate',
                'ModifyDate'
            ];

            for (const field of dateFields) {
                if (exifData[field]) {
                    return formatExifDate(exifData[field]);
                }
            }

            console.warn("üåò Aucune date trouv√©e dans les EXIF, meuf. C‚Äôest peut-√™tre un clich√© intemporel ?");
            return null;
        }

        function formatExifDate(rawDate) {
            // Exemple EXIF : "2023:07:14 10:45:30"
            if (typeof rawDate === 'string') {
                const parts = rawDate.split(' ');
                const datePart = parts[0].replace(/:/g, '-');
                const timePart = parts[1];
                const formattedDate = `${datePart}T${timePart}`;
                const isoString = formattedDate.length >= 19 ? formattedDate : formattedDate + ':00Z';
                return new Date(isoString);
            }

            // Si c‚Äôest d√©j√† un objet Date ou timestamp num√©rique
            if (rawDate instanceof Date) return rawDate;
            if (typeof rawDate === 'number') return new Date(rawDate);

            return null;
        }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Upload area functionality
            const uploadArea = document.getElementById('uploadArea');
            const imageUpload = document.getElementById('imageUpload');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const removeImage = document.getElementById('removeImage');
            const detectButton = document.getElementById('detectButton');
            const regionSelect = document.getElementById('regionSelect');

            // Results section
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultsSection = document.getElementById('resultsSection');

            // Camera functionality
            const captureButton = document.getElementById('captureButton');
            const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
            const cameraFeed = document.getElementById('cameraFeed');
            const captureCanvas = document.getElementById('captureCanvas');
            const takePictureButton = document.getElementById('takePictureButton');

            // Upload area click handler
            uploadArea.addEventListener('click', function () {
                imageUpload.click();
            });

            // File upload handler
            imageUpload.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        uploadPlaceholder.style.display = 'none';
                        imagePreviewContainer.style.display = 'block';
                        checkFormValidity();
                    }

                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Remove image handler
            removeImage.addEventListener('click', function (e) {
                e.stopPropagation();
                imageUpload.value = '';
                imagePreview.src = '';
                uploadPlaceholder.style.display = 'block';
                imagePreviewContainer.style.display = 'none';
                checkFormValidity();
            });

            // Region select handler
            regionSelect.addEventListener('change', function () {
                checkFormValidity();
            });

            // Check if form is valid
            function checkFormValidity() {
                if (imagePreviewContainer.style.display === 'block' &&
                    (regionSelect.value !== null && regionSelect.value !== 'Choisissez une r√©gion')) {
                    detectButton.disabled = false;
                } else {
                    detectButton.disabled = true;
                }
            }

            // Detect button handler
            detectButton.addEventListener('click', function () {
                // Show loading spinner
                loadingSpinner.style.display = 'block';
                resultsSection.style.display = 'none';

                // Simulate API call
                const formData = new FormData();
                formData.append('image', imagePreview.src);
                let exif = ""
                let date = ""
                EXIF.getData(imagePreview, function () {
                    exif = EXIF.getAllTags(this);
                    coo = extractCoordinates(exif)
                    date: date = extractExifDate(exif)
                    console.log("DATE", date);

                });
                console.log(exif);
                formData.append('coordinates', JSON.stringify(coo));
                formData.append('date', date.toISOString());


                fetch('{% url "analize" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfToken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        loadingSpinner.style.display = 'none';
                        resultsSection.style.display = 'block';

                        // Populate results with sample data
                        // In a real app, this would come from the API
                        document.getElementById('speciesName').textContent = data.name;
                        document.getElementById('speciesLatinName').textContent = data.latin;
                        const imageBlob = atob(data.img);
                        const arrayBuffer = new Uint8Array(imageBlob.length);
                        for (let i = 0; i < imageBlob.length; i++) {
                            arrayBuffer[i] = imageBlob.charCodeAt(i);
                        }
                        const imageBlobUrl = URL.createObjectURL(new Blob([arrayBuffer], { type: 'image/jpg' }));
                        document.getElementById('speciesImage').src = imageBlobUrl;
                        document.getElementById('speciesDescription').textContent = data.description;
                        document.getElementById('speciesHabitat').textContent = data.habitat;
                        document.getElementById('trackInfo').textContent = data.track_info;

                        document.getElementById('confidenceLevel').style.width = `${data.confidence}%`;
                        document.getElementById('confidenceText').textContent = `${data.confidence}%`;

                        // Scroll to results
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                    });
            });

            // Camera functionality
            captureButton.addEventListener('click', function () {
                // Check if browser supports getUserMedia
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function (stream) {
                            cameraFeed.srcObject = stream;
                            cameraModal.show();
                        })
                        .catch(function (error) {
                            console.error("Camera error: ", error);
                            alert("Impossible d'acc√©der √† la cam√©ra. Veuillez v√©rifier les permissions.");
                        });
                } else {
                    alert("Votre navigateur ne supporte pas l'acc√®s √† la cam√©ra.");
                }
            });

            // Take picture handler
            takePictureButton.addEventListener('click', function () {
                const context = captureCanvas.getContext('2d');
                captureCanvas.width = cameraFeed.videoWidth;
                captureCanvas.height = cameraFeed.videoHeight;
                context.drawImage(cameraFeed, 0, 0, captureCanvas.width, captureCanvas.height);

                const imageDataUrl = captureCanvas.toDataURL('image/png');
                imagePreview.src = imageDataUrl;
                uploadPlaceholder.style.display = 'none';
                imagePreviewContainer.style.display = 'block';

                // Stop camera stream
                const stream = cameraFeed.srcObject;
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());

                cameraModal.hide();
                checkFormValidity();
            });

            // Clean up camera when modal is closed
            document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function () {
                if (cameraFeed.srcObject) {
                    const stream = cameraFeed.srcObject;
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                }
            });

            // Gallery button handler
            document.getElementById('galleryButton').addEventListener('click', function () {
                // Simulate selecting an example image
                imagePreview.src = 'https://via.placeholder.com/400x300?text=Exemple+d\'empreinte';
                uploadPlaceholder.style.display = 'none';
                imagePreviewContainer.style.display = 'block';
                checkFormValidity();
            });

        });
    </script>
</body>

</html>